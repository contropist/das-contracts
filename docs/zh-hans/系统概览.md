# DAS 系统设计

此文档为 DAS 系统的概览说明文档，主要目的是为了说明系统的整体运作方式，以及各个模块之间的交互方式、顺序。


## Big Picture

整个 DAS 都是围绕 CKB 这条链运行的，但首先我们从一个更容易理解的，用户注册使用账户的场景来了解 DAS 的运行全局情况：

![全景图](DAS-big-picture.png)

1. 用户首先需要通过交易所、钱包中的浏览器访问 DAS 的注册服务；
2. 注册服务(**Registrar**)可以是由任何人实现的为用户提供 DAS 注册功能的 web 服务，当然不仅限于 web 服务，任何可以帮助用户完成链上交互并获得账户的应用都可以称为注册服务；
3. 注册服务将用户的注册请求以及其他各种操作转换成交易，通过钱包让用户签名后上链；
4. 守护服务(**Keeper**)是去中心化的 DAS 节点，随时通过节点 RPC 监控链上交易；
5. 当发现需要处理的用户交易时，就按照[交易结构协议](数据结构/交易结构协议.md)创建特定的交易完成诸如账户注册等工作；
6. 如果注册服务做的比较完善，可以通过节点的 RPC 监控用户的账户注册等状态，并在成功后及时的反馈用户；
7. 当用户注册成功账户，并设置解析记录后，解析服务(**Resolver**)就可以通过节点 RPC 解析链上区块获取数据；
8. 最后，解析服务通过自己的 RPC 接口将数据提供给钱包、交易所等需要使用解析记录的应用完成对用户账户的利用；


## 账户唯一性和注册流程

经过上面的账户注册流程之后，就创建了 DAS 中最核心的一项资产，即 DAS 账户。其核心价值所在就是唯一性，而理解 DAS 账户唯一性的关键就在于理解 DAS 账户的注册流程，所以这里对注册流程做一个简单的概览，如下图所示：

![注册流程](DAS-register-process.png)

- 首先用户需要申请注册，这一步用户的账户名是被 hash 的保密状态，这里的设计及其原理详见[防抢注机制](防抢注机制/防抢注机制.md)；
- 等待一段时间后用户可以发起预注册交易，提供需要账户名的明文以及注册费；
- 如果守护服务在链上发现了预注册交易，它就检查账户名的唯一性并创建一个携带唯一性证明的提案，并广播一笔基于这个提案生成的交易；
- 最后等待一段时间后，守护服务就可以确认提案，完成新账户的注册，这里的设计及其原理详见[账户链机制](账户链机制/账户链机制.md)；

上面每一步，除了“等待”以外每一步对应一笔交易，如果期望深入理解详见[数据结构/交易结构协议](数据结构/交易结构协议.md)。


## 链上账户结构

当账户注册成功后账户信息就会通过一个 Cell 保存在链上，而这一个个的 Cell 最终可以构成**一个单向有序链表**，也就是账户注册流程中唯一性的证明：

![链上账户结构](DAS-account-structure.png)

### 账户管理

账户的管理操作可以分为两类：一类是通过交易修改账户的写入操作，另一类是通过解析它的数据读取账户信息的读取操作。
对于写入类操作，除了了解账户的结构意外还必须了解各种账户相关的交易，比如：

- [账户转让](数据结构/交易结构协议.md)；
- [修改管理员](数据结构/交易结构协议.md)；
- [修改记录](数据结构/交易结构协议.md)；
- [账户续期](数据结构/交易结构协议.md)；

对于读取类操作，只需要了解 AccountCell 的数据结构即可，详见[Cell 结构协议](数据结构/Cell%20结构协议.md) 。

### 账户生命周期

在操作账户时，千万要注意的一个因素是**账户的生命周期**：

![账户生命周期](DAS-account-lifecycle.png)

对应上图中生命周期的每个状态分别是：

- **正常状态**，这种就是用户注册好账户后，正常缴交账户年费时的状态；
- **冻结状态**，当账户超过了续费的时间点之后，账户就会进入冻结状态，此时账户结构依然完整，无法再进行任何写入操作，读取操作因为是在链下实现，所以合约无法限制，但是**建议针对此种状态的账户给出明确的警告和提示**；
- **逾期状态**，当账户超过冻结期限还未续费，账户就会进入逾期状态，此时守护服务可以对账户进行回收，**账户被回收后就不再存在于链上了**；

由于 CKB 链的特性，账户对过期时间的判断是依赖于被称为 TimeCell 的一个特殊 cell ，由 Nervos 团队开发了其合约脚本并且现[已开源](https://github.com/nervina-labs/ckb-time-scripts) ，**注意 TimeCell 和现实时间是有误差的，只是它已经足以作为链上时间的参考值了。**

### 解析记录

解析记录是每个账户最最重要的数据，日常的转账、身份识别等基本应用场景就是需要围绕解析记录而建立的。单个账户的解析记录并没有明确的条数限制，但由于合约执行开销限制以及 signall lock script 对 `witnesses` 的体积限制，所以总的解析记录体积还是存在上限。每条解析记录都包含以下字段：

- `type` 字段为记录类型，目前必须是 `address, profile, custom_keys` 当中的一个；
- `key` 字段为记录的 key ，根据不同的 `type` 有不同的 key 可以使用，比如 btc, eth, email 等；
- `label` 字段为用户对记录的自定义命名；
- `value` 字段为记录的具体值，合约脚本并不会验证地址或 email 的格式，应用必须在链下做好检查；
- `ttl` 字段为记录的有效期，单位为 秒，各级缓存应该在此有效期后及时更新缓存；

> 在前端的接口层面，出于表达简洁的目的 `type` 和 `key` 被合并为了一个 `key` ，中间以 `.` 号进行分割。


## 参与 DAS 生态

就如同在 [Big Picture](#big-picture) 中看到的一样，想要参与 DAS 生态的方法就是成为其中一个角色：

- User ，即普通用户，是门槛最低的一种角色，现在访问 https://da.systems/ 即可注册获得一个个人账户；
- Exchange/Wallet ，即交易所/钱包，这个角色通常是已经开展此类业务的专业团队或公司扮演；
- Registrar ，即注册服务，成为这个角色需要解决用户支付的支付问题，然后根据[交易结构协议-注册相关交易](数据结构/交易结构协议.md#注册相关交易)实现发送链上交易即可成为注册服务商；
- Keeper ，即守护服务，目前所实现的 Keeper 性能较差，因此尚未开源，若期望成为这个角色要求完全熟悉[Cell 结构协议](数据结构/Cell-结构协议.md)和[交易结构协议](数据结构/交易结构协议.md)并能够据此开发服务端才可以；
- Resolver ，即解析服务，成为这个角色需要能够运维服务器，并在服务器上运行我们的[解析服务源码](https://github.com/DeAccountSystems/das_account_indexer) 即可，但是因为此角色没有任何收益，且交易所/钱包出于安全的目的只会使用自己维护的解析服务，所以并不推荐单独搭建此服务；

不管你想以以上哪一个角色的身份参与到 DAS 生态中来，如果有任何技术疑问我们都随时欢迎到我们的 Wechat 群组进行咨询，你可以在我们的官网首页找到邀请链接。 🤝
